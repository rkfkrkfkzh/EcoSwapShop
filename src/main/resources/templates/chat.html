<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>

<div id="chatMessages">
    <div th:each="message : ${chatHistory}">
        <div class="message">
            <span class="sender" th:text="${message.senderId}"></span>:
            <span class="content" th:text="${message.content}"></span>
            <span class="timestamp" th:text="${message.timestamp}"></span>
        </div>
    </div>
</div>

<input type="text" id="messageInput" placeholder="Enter your message here">
<button onclick="sendMessage()">Send</button>
<button onclick="exitChat()">대화 나가기</button>

<script th:inline="javascript">
    /* 변수 선언 */
    var sessionId = [[${sessionId}]]; // Thymeleaf를 통해 세션 ID를 가져옵니다.
    var receiverId = [[${receiverId}]];
    var senderId = [[${senderId}]];
    var productId = [[${productId}]];
</script>

<script type="text/javascript">
    /* 웹소켓 연결 및 메시지 기능 스크립트 */
    let socket = new SockJS('/ws');
    let stompClient = Stomp.over(socket);

    function scrollToBottom() {
        var messageArea = document.getElementById('chatMessages');
        messageArea.scrollTop = messageArea.scrollHeight;
    }

    window.onload = function () {
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/' + sessionId, function (messageOutput) {
                displayMessage(JSON.parse(messageOutput.body));
                scrollToBottom();
            });
        }, function (error) {
            alert('웹소켓 연결에 실패했습니다: ' + error);
        });
    };

    function displayMessage(message) {
        let messageArea = document.getElementById('chatMessages');
        let messageDiv = document.createElement('div');
        messageDiv.className = 'message';

        let senderSpan = document.createElement('span');
        senderSpan.className = 'sender';
        senderSpan.textContent = message.senderId;
        messageDiv.appendChild(senderSpan);

        messageDiv.appendChild(document.createTextNode(': '));

        let contentSpan = document.createElement('span');
        contentSpan.className = 'content';
        contentSpan.textContent = message.content;
        messageDiv.appendChild(contentSpan);

        let timestampSpan = document.createElement('span');
        timestampSpan.className = 'timestamp';
        timestampSpan.textContent = ' (' + message.timestamp + ')';
        messageDiv.appendChild(timestampSpan);

        messageArea.appendChild(messageDiv);
    }

    function sendMessage() {
        let messageInput = document.getElementById('messageInput');
        if (stompClient && stompClient.connected && messageInput.value.trim() !== "") {

            let chatMessage = {
                senderId: senderId,
                receiverId: receiverId,
                content: messageInput.value.trim(),
                productId: productId,
                // 세션 ID 추가
                sessionId: sessionId,
                timestamp: new Date().toLocaleString()
            };
            stompClient.send("/app/chat/" + sessionId, {}, JSON.stringify(chatMessage));

            // 입력 필드 초기화 및 포커스
            messageInput.value = '';
            messageInput.focus();
        } else {
            alert('웹소켓 연결이 끊어졌습니다. 페이지를 새로고침하세요.');
        }
    }

    function exitChat() {
        window.history.back();
    }
</script>

</body>
</html>
