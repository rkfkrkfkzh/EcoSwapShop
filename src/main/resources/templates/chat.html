<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chat</title>
    <!-- 웹소켓 라이브러리 추가 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/style.css}"> <!-- Link to your custom CSS file -->
</head>

<body>
<<!-- 채팅 메시지 영역 -->
<div id="chatMessages">
    <!-- 이전 채팅 메시지 표시 -->
    <div th:each="message : ${chatHistory}">
        <div class="message">
            <span class="sender" th:text="${message.senderId}"></span>:
            <span class="content" th:text="${message.content}"></span>
            <span class="timestamp" th:text="${message.timestamp}"></span>
        </div>
    </div>
</div>

<input type="text" id="messageInput" placeholder="Enter your message here">
<button onclick="sendMessage()">Send</button>
<button onclick="exitChat()">대화 나가기</button>

<script th:inline="javascript">
    var receiverId = [[${receiverId}]];  // 수신자 ID
    var senderId = [[${senderId}]];      // 발신자 ID
    var productId = [[${productId}]];  // 상품 ID
</script>

<script type="text/javascript">
    let socket = new SockJS('/ws');  // 웹소켓 엔드포인트 지정 (서버 측 엔드포인트와 일치해야 합니다)
    let stompClient = Stomp.over(socket);

    // 웹페이지가 로드될 때 웹소켓 연결
    window.onload = function () {
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            // 새로운 메시지를 받았을 때 메시지 표시
            stompClient.subscribe('/topic/' + receiverId + "/" + productId, function (messageOutput) {
                let message = JSON.parse(messageOutput.body);
                let messageArea = document.getElementById('chatMessages');
                let messageDiv = document.createElement('div');
                messageDiv.className = 'message';

                let senderSpan = document.createElement('span');
                senderSpan.className = 'sender';
                senderSpan.textContent = message.senderId;
                messageDiv.appendChild(senderSpan);

                messageDiv.appendChild(document.createTextNode(': '));

                let contentSpan = document.createElement('span');
                contentSpan.className = 'content';
                contentSpan.textContent = message.content;
                messageDiv.appendChild(contentSpan);

                let timestampSpan = document.createElement('span');
                timestampSpan.className = 'timestamp';
                timestampSpan.textContent = ' (' + message.timestamp + ')';
                messageDiv.appendChild(timestampSpan);

                messageArea.appendChild(messageDiv);
            });
        });
    };

    // 메시지 전송 함수
    function sendMessage() {
        let messageInput = document.getElementById('messageInput');
        if (stompClient && messageInput.value.trim() !== "") {
            let chatMessage = {
                senderId: senderId,                  // 발신자 ID 추가
                receiverId: receiverId,              // 수신자 ID 추가
                content: messageInput.value.trim(),
                productId: productId,
                timestamp: new Date().toLocaleString()
            };
            stompClient.send("/app/chat/" + receiverId + "/" + productId, {}, JSON.stringify(chatMessage));
            messageInput.value = '';
        }
    }

    // 대화나가기
    function exitChat() {
        window.history.back();
    }

</script>

</body>
</html>
